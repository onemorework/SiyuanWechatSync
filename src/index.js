"use strict";var Q=Object.defineProperty;var W=(t,e,n)=>e in t?Q(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var m=(t,e,n)=>W(t,typeof e!="symbol"?e+"":e,n);const b=require("siyuan");function E(){}function V(t){return t()}function Y(){return Object.create(null)}function N(t){t.forEach(V)}function F(t){return typeof t=="function"}function X(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function Z(t){return Object.keys(t).length===0}function c(t,e){t.appendChild(e)}function tt(t,e,n){t.insertBefore(e,n||null)}function G(t){t.parentNode&&t.parentNode.removeChild(t)}function d(t){return document.createElement(t)}function et(t){return document.createTextNode(t)}function w(){return et(" ")}function j(t,e,n,i){return t.addEventListener(e,n,i),()=>t.removeEventListener(e,n,i)}function l(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function J(t){return t===""?null:+t}function nt(t){return Array.from(t.childNodes)}function x(t,e){t.value=e??""}let O;function C(t){O=t}const $=[],q=[];let S=[];const R=[],it=Promise.resolve();let A=!1;function st(){A||(A=!0,it.then(K))}function B(t){S.push(t)}const M=new Set;let k=0;function K(){if(k!==0)return;const t=O;do{try{for(;k<$.length;){const e=$[k];k++,C(e),lt(e.$$)}}catch(e){throw $.length=0,k=0,e}for(C(null),$.length=0,k=0;q.length;)q.pop()();for(let e=0;e<S.length;e+=1){const n=S[e];M.has(n)||(M.add(n),n())}S.length=0}while($.length);for(;R.length;)R.pop()();A=!1,M.clear(),C(t)}function lt(t){if(t.fragment!==null){t.update(),N(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(B)}}function ot(t){const e=[],n=[];S.forEach(i=>t.indexOf(i)===-1?e.push(i):n.push(i)),n.forEach(i=>i()),S=e}const rt=new Set;function at(t,e){t&&t.i&&(rt.delete(t),t.i(e))}function ct(t,e,n){const{fragment:i,after_update:o}=t.$$;i&&i.m(e,n),B(()=>{const r=t.$$.on_mount.map(V).filter(F);t.$$.on_destroy?t.$$.on_destroy.push(...r):N(r),t.$$.on_mount=[]}),o.forEach(B)}function ft(t,e){const n=t.$$;n.fragment!==null&&(ot(n.after_update),N(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function ut(t,e){t.$$.dirty[0]===-1&&($.push(t),st(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function dt(t,e,n,i,o,r,f=null,v=[-1]){const u=O;C(t);const s=t.$$={fragment:null,ctx:[],props:r,update:E,not_equal:o,bound:Y(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(u?u.$$.context:[])),callbacks:Y(),dirty:v,skip_bound:!1,root:e.target||u.$$.root};f&&f(s.root);let h=!1;if(s.ctx=n?n(t,e.props||{},(a,T,...y)=>{const p=y.length?y[0]:T;return s.ctx&&o(s.ctx[a],s.ctx[a]=p)&&(!s.skip_bound&&s.bound[a]&&s.bound[a](p),h&&ut(t,a)),T}):[],s.update(),h=!0,N(s.before_update),s.fragment=i?i(s.ctx):!1,e.target){if(e.hydrate){const a=nt(e.target);s.fragment&&s.fragment.l(a),a.forEach(G)}else s.fragment&&s.fragment.c();e.intro&&at(t.$$.fragment),ct(t,e.target,e.anchor),K()}C(u)}class ht{constructor(){m(this,"$$");m(this,"$$set")}$destroy(){ft(this,1),this.$destroy=E}$on(e,n){if(!F(n))return E;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(n),()=>{const o=i.indexOf(n);o!==-1&&i.splice(o,1)}}$set(e){this.$$set&&!Z(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const gt="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(gt);function _t(t){let e,n,i,o,r,f,v,u,s,h,a,T,y,p,z,g,H,P,I,U,L;return{c(){e=d("div"),n=d("div"),i=d("div"),o=d("label"),o.textContent="服务器地址",r=w(),f=d("input"),v=w(),u=d("div"),s=d("label"),s.textContent="Token",h=w(),a=d("input"),T=w(),y=d("div"),p=d("label"),p.textContent="同步周期（秒）",z=w(),g=d("input"),H=w(),P=d("div"),I=d("button"),I.textContent="保存",l(o,"for","syncInterval"),l(o,"class","fn__flex svelte-1xc5fpt"),l(f,"type","text"),l(f,"class","b3-text-field fn__flex-1"),l(f,"placeholder","请输入服务器地址"),l(i,"class","config__item svelte-1xc5fpt"),l(s,"for","syncInterval"),l(s,"class","fn__flex svelte-1xc5fpt"),l(a,"type","password"),l(a,"class","b3-text-field fn__flex-1"),l(a,"placeholder","请输入认证Token"),l(u,"class","config__item svelte-1xc5fpt"),l(p,"for","syncInterval"),l(p,"class","fn__flex svelte-1xc5fpt"),l(g,"type","number"),l(g,"class","b3-text-field fn__flex-1"),l(g,"min","0"),l(g,"placeholder","请输入同步周期（秒）"),l(y,"class","config__item svelte-1xc5fpt"),l(n,"class","b3-dialog__body"),l(I,"class","b3-button b3-button--primary"),l(P,"class","b3-dialog__action"),l(e,"class","b3-dialog__content")},m(_,D){tt(_,e,D),c(e,n),c(n,i),c(i,o),c(i,r),c(i,f),x(f,t[0].serverUrl),c(n,v),c(n,u),c(u,s),c(u,h),c(u,a),x(a,t[0].token),c(n,T),c(n,y),c(y,p),c(y,z),c(y,g),x(g,t[0].syncInterval),c(e,H),c(e,P),c(P,I),U||(L=[j(f,"input",t[4]),j(a,"input",t[5]),j(g,"input",t[6]),j(I,"click",t[1])],U=!0)},p(_,[D]){D&1&&f.value!==_[0].serverUrl&&x(f,_[0].serverUrl),D&1&&a.value!==_[0].token&&x(a,_[0].token),D&1&&J(g.value)!==_[0].syncInterval&&x(g,_[0].syncInterval)},i:E,o:E,d(_){_&&G(e),U=!1,N(L)}}}function yt(t,e,n){let{config:i}=e,{save:o}=e,r={...i};function f(){o(r)}function v(){r.serverUrl=this.value,n(0,r)}function u(){r.token=this.value,n(0,r)}function s(){r.syncInterval=J(this.value),n(0,r)}return t.$$set=h=>{"config"in h&&n(2,i=h.config),"save"in h&&n(3,o=h.save)},[r,f,i,o,v,u,s]}class pt extends ht{constructor(e){super(),dt(this,e,yt,_t,X,{config:2,save:3})}}const vt={SYNC:'<svg viewBox="0 0 1244 1024" class="icon" style="width: 1em; height: 1em;"><path d="M1187.254857 480.987429a272.384 272.384 0 0 0-110.08-84.260572 426.349714 426.349714 0 0 0-124.489143-269.897143A426.715429 426.715429 0 0 0 648.923429 1.024a425.545143 425.545143 0 0 0-259.657143 87.259429 432.128 432.128 0 0 0-142.628572 191.195428 320.731429 320.731429 0 0 0-166.253714 100.205714 320.585143 320.585143 0 0 0-22.235429 395.922286 320 320 0 0 0 148.041143 116.004572 49.956571 49.956571 0 0 0 35.84-93.257143a221.184 221.184 0 0 1-86.893714-352.548572 221.769143 221.769143 0 0 1 136.045714-73.142857h0.219429c0.731429-0.219429 1.243429-0.219429 1.974857-0.292571l0.731429-0.146286a7.168 7.168 0 0 1 1.462857-0.292571l1.097143-0.292572 1.170285-0.292571 1.389715-0.365715 0.731428-0.146285a9.654857 9.654857 0 0 0 1.755429-0.731429s0.146286 0 0.146285-0.146286a49.371429 49.371429 0 0 0 12.434286-6.802285H314.514286c0.585143-0.365714 1.170286-0.804571 1.682285-1.389715l0.585143-0.365714 1.243429-1.170286c0.292571-0.219429 0.512-0.512 0.950857-0.731428l0.731429-0.731429 1.243428-1.316571 0.365714-0.365714c0.438857-0.585143 1.024-1.097143 1.462858-1.536l0.073142-0.146286 1.462858-1.828572 0.073142-0.146285 1.243429-1.755429 0.146286-0.146286 1.097143-1.682285 0.292571-0.438857 0.804571-1.462858 0.438858-0.731428 0.731428-1.243429c0.073143-0.438857 0.365714-0.731429 0.512-1.097143l0.438857-0.950857 0.731429-1.536c0.073143-0.146286 0.073143-0.438857 0.219428-0.585143 0.292571-0.731429 0.585143-1.243429 0.731429-1.901714l0.073143-0.292571c0.292571-0.877714 0.585143-1.536 0.731428-2.413715a332.8 332.8 0 0 1 117.101715-169.398857 327.314286 327.314286 0 0 1 199.168-66.925714c88.137143 0 170.861714 34.304 233.106285 96.548571a327.387429 327.387429 0 0 1 96.621715 233.179429c0 16.018286 7.460571 30.281143 19.163428 39.277714 5.851429 5.705143 13.019429 10.020571 21.504 12.214857a169.545143 169.545143 0 0 1 124.050286 163.108572c0 31.597714-15.286857 71.021714-39.716571 102.546286-22.601143 29.110857-49.737143 47.177143-70.948572 47.177142a49.956571 49.956571 0 1 0 0 99.913143c52.955429 0 107.52-31.378286 149.942857-85.942857 38.034286-49.005714 60.781714-110.153143 60.781715-163.84a267.190857 267.190857 0 0 0-56.027429-164.059428z M863.451429 740.644571H375.222857a49.883429 49.883429 0 0 0-37.156571 83.017143l130.194285 144.822857a49.737143 49.737143 0 0 0 70.436572 3.803429 49.737143 49.737143 0 0 0 3.803428-70.509714l-55.296-61.659429h376.100572a49.956571 49.956571 0 0 0 49.956571-49.956571 49.444571 49.444571 0 0 0-49.737143-49.517715z M325.485714 612.937143c0 27.648 22.381714 50.029714 49.956572 50.029714h488.228571c11.264 0 22.674286-3.803429 31.890286-11.556571a50.176 50.176 0 0 0 5.558857-71.606857l-129.462857-144.822858a50.029714 50.029714 0 1 0-74.386286 66.56l55.076572 61.586286H375.369143a49.737143 49.737143 0 0 0-49.956572 49.810286z" fill="currentColor"/></svg>'};class mt extends b.Plugin{constructor(){super(...arguments);m(this,"settingDialog");m(this,"syncTimer");m(this,"config")}async onload(){this.config=await this.loadData("config.json")||{serverUrl:"",token:"",syncInterval:3600},this.addTopBar({icon:vt.SYNC,title:this.i18n.setting,position:"right",callback:()=>{this.showSetting()}}),this.startSyncTimer()}showSetting(){this.settingDialog&&this.settingDialog.destroy(),this.settingDialog=new b.Dialog({title:"同步设置",content:'<div id="syncPluginSetting"></div>',width:"600px"}),new pt({target:document.getElementById("syncPluginSetting"),props:{config:this.config,save:async n=>{this.config=n,await this.saveData("config.json",this.config),this.restartSyncTimer(),b.showMessage("设置已保存"),this.settingDialog.destroy()},syncNow:()=>{this.syncData()}}})}startSyncTimer(){this.syncTimer&&clearInterval(this.syncTimer),this.config.syncInterval>0&&(this.syncTimer=setInterval(()=>{this.syncData()},this.config.syncInterval*1e3))}restartSyncTimer(){this.startSyncTimer()}async syncData(){try{console.log(this.config.serverUrl);const n=await fetch(this.config.serverUrl,{headers:{Authorization:`Bearer ${this.config.token}`}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);b.fetchPost("/api/notebook/lsNotebooks",{},o=>{const r=new Date(o.data).toString();console.log(r)}),console.log(n.json);const i=await n.json();await this.writeDataToDoc(i),b.showMessage("同步成功")}catch(n){b.showMessage(`同步失败: ${n.message}`)}}async writeDataToDoc(n){console.log(n)}onunload(){this.syncTimer&&clearInterval(this.syncTimer)}}module.exports=mt;
