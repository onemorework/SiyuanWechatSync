"use strict";var T=Object.defineProperty;var S=(u,e,t)=>e in u?T(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var m=(u,e,t)=>S(u,typeof e!="symbol"?e+"":e,t);const p=require("siyuan"),_={CURR:'<svg t="1734852463945" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4264" width="200" height="200"><path d="M522.666667 855.466667C328.533333 855.466667 170.666667 697.6 170.666667 503.466667c0-70.4 21.333333-140.8 61.866666-198.4 10.666667-14.933333 29.866667-19.2 44.8-8.533334 14.933333 10.666667 19.2 29.866667 8.533334 44.8-32 46.933333-51.2 104.533333-51.2 162.133334 0 157.866667 130.133333 288 288 288 32 0 66.133333-6.4 96-17.066667 17.066667-6.4 34.133333 2.133333 40.533333 19.2s-2.133333 34.133333-19.2 40.533333c-38.4 14.933333-76.8 21.333333-117.333333 21.333334zM761.6 748.8c-8.533333 0-14.933333-2.133333-21.333333-8.533333-12.8-12.8-14.933333-32-2.133334-44.8 46.933333-53.333333 72.533333-121.6 72.533334-192 0-157.866667-130.133333-288-288-288-46.933333 0-93.866667 10.666667-134.4 34.133333-14.933333 8.533333-34.133333 2.133333-42.666667-12.8s-2.133333-34.133333 12.8-42.666667c51.2-25.6 106.666667-40.533333 164.266667-40.533333 194.133333 0 352 157.866667 352 352 0 87.466667-32 170.666667-89.6 234.666667-6.4 4.266667-14.933333 8.533333-23.466667 8.533333z" fill="#7F8080" p-id="4265"></path><path d="M469.333333 311.466667c-6.4 0-10.666667-2.133333-17.066666-4.266667l-113.066667-64c-14.933333-8.533333-19.2-25.6-12.8-40.533333L375.466667 85.333333c6.4-17.066667 25.6-23.466667 42.666666-17.066666 17.066667 6.4 23.466667 25.6 17.066667 42.666666l-38.4 89.6 87.466667 51.2c14.933333 8.533333 21.333333 27.733333 10.666666 42.666667-4.266667 10.666667-14.933333 17.066667-25.6 17.066667zM584.533333 949.333333c-6.4 0-12.8-2.133333-17.066666-4.266666-14.933333-8.533333-19.2-29.866667-10.666667-44.8l53.333333-83.2-78.933333-66.133334c-12.8-10.666667-14.933333-32-4.266667-44.8 10.666667-12.8 32-14.933333 44.8-4.266666l100.266667 83.2c12.8 10.666667 14.933333 27.733333 6.4 42.666666l-68.266667 106.666667c-4.266667 8.533333-14.933333 14.933333-25.6 14.933333z" fill="#7F8080" p-id="4266"></path></svg>',SYNC:'<svg viewBox="0 0 1244 1024" class="icon" style="width: 1em; height: 1em;"><path d="M1187.254857 480.987429a272.384 272.384 0 0 0-110.08-84.260572 426.349714 426.349714 0 0 0-124.489143-269.897143A426.715429 426.715429 0 0 0 648.923429 1.024a425.545143 425.545143 0 0 0-259.657143 87.259429 432.128 432.128 0 0 0-142.628572 191.195428 320.731429 320.731429 0 0 0-166.253714 100.205714 320.585143 320.585143 0 0 0-22.235429 395.922286 320 320 0 0 0 148.041143 116.004572 49.956571 49.956571 0 0 0 35.84-93.257143a221.184 221.184 0 0 1-86.893714-352.548572 221.769143 221.769143 0 0 1 136.045714-73.142857h0.219429c0.731429-0.219429 1.243429-0.219429 1.974857-0.292571l0.731429-0.146286a7.168 7.168 0 0 1 1.462857-0.292571l1.097143-0.292572 1.170285-0.292571 1.389715-0.365715 0.731428-0.146285a9.654857 9.654857 0 0 0 1.755429-0.731429s0.146286 0 0.146285-0.146286a49.371429 49.371429 0 0 0 12.434286-6.802285H314.514286c0.585143-0.365714 1.170286-0.804571 1.682285-1.389715l0.585143-0.365714 1.243429-1.170286c0.292571-0.219429 0.512-0.512 0.950857-0.731428l0.731429-0.731429 1.243428-1.316571 0.365714-0.365714c0.438857-0.585143 1.024-1.097143 1.462858-1.536l0.073142-0.146286 1.462858-1.828572 0.073142-0.146285 1.243429-1.755429 0.146286-0.146286 1.097143-1.682285 0.292571-0.438857 0.804571-1.462858 0.438858-0.731428 0.731428-1.243429c0.073143-0.438857 0.365714-0.731429 0.512-1.097143l0.438857-0.950857 0.731429-1.536c0.073143-0.146286 0.073143-0.438857 0.219428-0.585143 0.292571-0.731429 0.585143-1.243429 0.731429-1.901714l0.073143-0.292571c0.292571-0.877714 0.585143-1.536 0.731428-2.413715a332.8 332.8 0 0 1 117.101715-169.398857 327.314286 327.314286 0 0 1 199.168-66.925714c88.137143 0 170.861714 34.304 233.106285 96.548571a327.387429 327.387429 0 0 1 96.621715 233.179429c0 16.018286 7.460571 30.281143 19.163428 39.277714 5.851429 5.705143 13.019429 10.020571 21.504 12.214857a169.545143 169.545143 0 0 1 124.050286 163.108572c0 31.597714-15.286857 71.021714-39.716571 102.546286-22.601143 29.110857-49.737143 47.177143-70.948572 47.177142a49.956571 49.956571 0 1 0 0 99.913143c52.955429 0 107.52-31.378286 149.942857-85.942857 38.034286-49.005714 60.781714-110.153143 60.781715-163.84a267.190857 267.190857 0 0 0-56.027429-164.059428z M863.451429 740.644571H375.222857a49.883429 49.883429 0 0 0-37.156571 83.017143l130.194285 144.822857a49.737143 49.737143 0 0 0 70.436572 3.803429 49.737143 49.737143 0 0 0 3.803428-70.509714l-55.296-61.659429h376.100572a49.956571 49.956571 0 0 0 49.956571-49.956571 49.444571 49.444571 0 0 0-49.737143-49.517715z M325.485714 612.937143c0 27.648 22.381714 50.029714 49.956572 50.029714h488.228571c11.264 0 22.674286-3.803429 31.890286-11.556571a50.176 50.176 0 0 0 5.558857-71.606857l-129.462857-144.822858a50.029714 50.029714 0 1 0-74.386286 66.56l55.076572 61.586286H375.369143a49.737143 49.737143 0 0 0-49.956572 49.810286z" fill="currentColor"/></svg>',SETTINGS:`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
        <path d="M29.181 19.070c-1.679-2.908-0.669-6.634 2.255-8.328l-3.145-5.447c-0.898 0.527-1.943 0.829-3.058 0.829-3.361 0-6.085-2.742-6.085-6.125h-6.289c0.008 1.044-0.252 2.103-0.811 3.070-1.679 2.908-5.411 3.897-8.339 2.211l-3.144 5.447c0.905 0.515 1.689 1.268 2.246 2.234 1.676 2.903 0.672 6.623-2.241 8.319l3.145 5.447c0.895-0.522 1.935-0.82 3.044-0.82 3.35 0 6.067 2.725 6.084 6.092h6.289c-0.003-1.034 0.259-2.080 0.811-3.038 1.676-2.903 5.399-3.894 8.325-2.219l3.145-5.447c-0.899-0.515-1.678-1.266-2.232-2.226zM16 22.479c-3.578 0-6.479-2.901-6.479-6.479s2.901-6.479 6.479-6.479c3.578 0 6.479 2.901 6.479 6.479s-2.901 6.479-6.479 6.479z"></path>
    </svg>`},$=u=>{let e;switch(u){case"checkbox":e=t=>t.checked;break;case"select":case"slider":case"textinput":case"textarea":e=t=>t.value;break;case"number":e=t=>parseInt(t.value);break;default:e=()=>null;break}return e},U=u=>{let e;switch(u){case"checkbox":e=(t,s)=>{t.checked=s};break;case"select":case"slider":case"textinput":case"textarea":case"number":e=(t,s)=>{t.value=s};break;default:e=()=>{};break}return e};class M{constructor(e){m(this,"plugin");m(this,"name");m(this,"file");m(this,"settings",new Map);m(this,"elements",new Map);this.name=e.name??"settings",this.plugin=e.plugin,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`,this.plugin.setting=new p.Setting({width:e.width,height:e.height,confirmCallback:()=>{for(let s of this.settings.keys())this.updateValueFromElement(s);let t=this.dump();e.callback!==void 0&&e.callback(t),this.plugin.data[this.name]=t,this.save(t)},destroyCallback:()=>{for(let t of this.settings.keys())this.updateElementFromValue(t)}})}async load(){let e=await this.plugin.loadData(this.file);if(console.debug("Load config:",e),e)for(let[t,s]of this.settings)s.value=(e==null?void 0:e[t])??s.value;return this.plugin.data[this.name]=this.dump(),e}async save(e){return e=e??this.dump(),await this.plugin.saveData(this.file,this.dump()),console.debug("Save config:",e),e}get(e){var t;return(t=this.settings.get(e))==null?void 0:t.value}set(e,t){let s=this.settings.get(e);s&&(s.value=t,this.updateElementFromValue(e))}async setAndSave(e,t){let s=this.settings.get(e);s&&(s.value=t,this.updateElementFromValue(e),await this.save())}take(e,t=!1){let s=this.settings.get(e),n=this.elements.get(e);if(n)return t&&this.updateValueFromElement(e),s.getEleVal(n)}async takeAndSave(e){let t=this.take(e,!0);return await this.save(),t}disable(e){let t=this.elements.get(e);t&&(t.disabled=!0)}enable(e){let t=this.elements.get(e);t&&(t.disabled=!1)}dump(){let e={};for(let[t,s]of this.settings)s.type!=="button"&&(e[t]=s.value);return e}addItem(e){if(this.settings.set(e.key,e),e.type==="custom"&&(e.createElement===void 0||e.getEleVal===void 0||e.setEleVal===void 0)){console.error("The custom setting item must have createElement, getEleVal and setEleVal methods");return}if(e.getEleVal===void 0&&(e.getEleVal=$(e.type)),e.setEleVal===void 0&&(e.setEleVal=U(e.type)),e.createElement===void 0){let n=this.createDefaultElement(e);this.elements.set(e.key,n),this.plugin.setting.addItem({title:e.title,description:e==null?void 0:e.description,direction:e==null?void 0:e.direction,createActionElement:()=>(this.updateElementFromValue(e.key),this.getElement(e.key))})}else this.plugin.setting.addItem({title:e.title,description:e==null?void 0:e.description,direction:e==null?void 0:e.direction,createActionElement:()=>{let n=this.get(e.key),i=e.createElement(n);return this.elements.set(e.key,i),i}})}createDefaultElement(e){var n,i,a,r,h,d,o,c,g;let t;const s=l=>{l.key==="Enter"&&(l.preventDefault(),l.stopImmediatePropagation())};switch(e.type){case"checkbox":let l=document.createElement("input");l.type="checkbox",l.checked=e.value,l.className="b3-switch fn__flex-center",t=l,l.onchange=((n=e.action)==null?void 0:n.callback)??(()=>{});break;case"select":let y=document.createElement("select");y.className="b3-select fn__flex-center fn__size200";let D=(e==null?void 0:e.options)??{};for(let v in D){let w=document.createElement("option"),x=D[v];w.value=v,w.text=x,y.appendChild(w)}y.value=e.value,y.onchange=((i=e.action)==null?void 0:i.callback)??(()=>{}),t=y;break;case"slider":let f=document.createElement("input");f.type="range",f.className="b3-slider fn__size200 b3-tooltips b3-tooltips__n",f.ariaLabel=e.value,f.min=((a=e.slider)==null?void 0:a.min.toString())??"0",f.max=((r=e.slider)==null?void 0:r.max.toString())??"100",f.step=((h=e.slider)==null?void 0:h.step.toString())??"1",f.value=e.value,f.onchange=()=>{var v;f.ariaLabel=f.value,(v=e.action)==null||v.callback()},t=f;break;case"textinput":let k=document.createElement("input");k.className="b3-text-field fn__flex-center fn__size200",k.value=e.value,k.onchange=((d=e.action)==null?void 0:d.callback)??(()=>{}),t=k,k.addEventListener("keydown",s);break;case"textarea":let E=document.createElement("textarea");E.className="b3-text-field fn__block",E.value=e.value,E.onchange=((o=e.action)==null?void 0:o.callback)??(()=>{}),t=E;break;case"number":let b=document.createElement("input");b.type="number",b.className="b3-text-field fn__flex-center fn__size200",b.value=e.value,t=b,b.addEventListener("keydown",s);break;case"button":let I=document.createElement("button");I.className="b3-button b3-button--outline fn__flex-center fn__size200",I.innerText=((c=e.button)==null?void 0:c.label)??"Button",I.onclick=((g=e.button)==null?void 0:g.callback)??(()=>{}),t=I;break;case"hint":let N=document.createElement("div");N.className="b3-label fn__flex-center",t=N;break}return t}getElement(e){return this.elements.get(e)}updateValueFromElement(e){let t=this.settings.get(e);if(t.type==="button")return;let s=this.elements.get(e);t.value=t.getEleVal(s)}updateElementFromValue(e){let t=this.settings.get(e);if(t.type==="button")return;let s=this.elements.get(e);t.setEleVal(s,t.value)}}class O extends p.Plugin{constructor(){super(...arguments);m(this,"syncTimer");m(this,"settingUtils");m(this,"config");m(this,"lastSyncTime",0)}async onload(){this.config=await this.loadData("config.json")||{token:"",syncInterval:3600,selectedNotebookId:"",selectedNotebookName:"",selectedDocId:"",selectedDocName:"",syncOnLoad:!0},this.settingUtils=new M({plugin:this,name:"sync-settings"}),this.settingUtils.addItem({key:"syncOnLoad",type:"checkbox",title:"加载时同步",value:this.config.syncOnLoad,description:"插件加载时立即同步一次数据",action:{callback:async()=>{const t=this.settingUtils.take("syncOnLoad",!0);this.config.syncOnLoad=t,await this.saveData("config.json",this.config)}}}),this.settingUtils.addItem({key:"token",type:"textinput",title:"Token",value:this.config.token,description:"访问令牌",action:{callback:async()=>{const t=this.settingUtils.take("token",!0);this.config.token=t,await this.saveData("config.json",this.config)}}}),this.settingUtils.addItem({key:"syncInterval",type:"number",title:"同步周期（秒）",value:this.config.syncInterval,description:"自动同步的时间间隔（0表示不自动同步）",action:{callback:async()=>{const t=this.settingUtils.take("syncInterval",!0);this.config.syncInterval=t,await this.saveData("config.json",this.config),this.startSyncTimer()}}}),this.settingUtils.addItem({key:"selectedNotebookId",type:"select",title:"选择笔记本",value:this.config.selectedNotebookId,description:"选择要同步的笔记本",options:{"":"请选择笔记本"},action:{callback:async()=>{var n,i;const t=this.settingUtils.take("selectedNotebookId",!0),s=((i=(n=this.settingUtils.getElement("selectedNotebookId"))==null?void 0:n.selectedOptions[0])==null?void 0:i.text)||"";this.config.selectedNotebookId=t,this.config.selectedNotebookName=s,this.config.selectedDocId="",this.config.selectedDocName="",await this.saveData("config.json",this.config),t&&p.fetchPost("/api/filetree/listDocsByPath",{notebook:t,path:"/",sort:0},async a=>{const r=a.data.files||[],h={"":"请选择文档"};Array.isArray(r)&&r.forEach(o=>{o.id&&o.name&&(h[o.id]=o.name)});const d=this.settingUtils.settings.get("selectedDocId");if(d){d.options=h,await this.saveData("config.json",this.config);const o=this.settingUtils.getElement("selectedDocId");o&&(o.innerHTML="",Object.entries(h).forEach(([c,g])=>{const l=document.createElement("option");l.value=c,l.text=g,o.appendChild(l)}),o.value=this.config.selectedDocId)}})}}}),this.settingUtils.addItem({key:"selectedDocId",type:"select",title:"选择文档",value:this.config.selectedDocId,description:"选择要同步的文档",options:{"":"请选择文档"},action:{callback:async()=>{var n,i;const t=this.settingUtils.take("selectedDocId",!0),s=((i=(n=this.settingUtils.getElement("selectedDocId"))==null?void 0:n.selectedOptions[0])==null?void 0:i.text)||"";this.config.selectedDocId=t,this.config.selectedDocName=s,await this.saveData("config.json",this.config)}}}),p.fetchPost("/api/notebook/lsNotebooks",{},async t=>{const s=t.data.notebooks||[],n={"":"请选择笔记本"};s.forEach(a=>{a.id&&a.name&&(n[a.id]=a.name)});const i=this.settingUtils.settings.get("selectedNotebookId");if(i){i.options=n;const a=this.settingUtils.getElement("selectedNotebookId");a&&(a.innerHTML="",Object.entries(n).forEach(([r,h])=>{const d=document.createElement("option");d.value=r,d.text=h,a.appendChild(d)}),a.value=this.config.selectedNotebookId),this.config.selectedNotebookId&&p.fetchPost("/api/filetree/listDocsByPath",{notebook:this.config.selectedNotebookId,path:"/",sort:0},r=>{const h=r.data.files||[],d={"":"请选择文档"};h.forEach(c=>{c.id&&c.name&&(d[c.id]=c.name)});const o=this.settingUtils.settings.get("selectedDocId");if(o){o.options=d;const c=this.settingUtils.getElement("selectedDocId");c&&(c.innerHTML="",Object.entries(d).forEach(([g,l])=>{const y=document.createElement("option");y.value=g,y.text=l,c.appendChild(y)}),c.value=this.config.selectedDocId)}})}}),this.addTopBar({icon:_.SYNC,title:"立即同步",position:"right",callback:()=>{this.syncData()}}),this.startSyncTimer(),this.config.syncOnLoad&&(console.log("插件加载，执行初始同步"),this.syncData(!1))}startSyncTimer(){this.syncTimer&&clearInterval(this.syncTimer),this.config.syncInterval>0?this.syncTimer=setInterval(()=>{this.syncData()},this.config.syncInterval*1e3):console.log("同步周期设置为0，不启动定时同步")}async syncData(t=!0){try{if(!this.config.selectedNotebookId||!this.config.selectedDocId){p.showMessage("请先选择笔记本和文档");return}console.log(`开始同步到笔记本 [${this.config.selectedNotebookName}] 的文档 [${this.config.selectedDocName}]`);const s=await fetch("https://sd.cloud.ifbemore.com/api/v1/note/records",{method:"GET",headers:{Authorization:`Bearer ${this.config.token}`,"Content-Type":"application/json"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const n=await s.json(),i=[];if(Array.isArray(n.data.list)&&n.data.list.length>0){for(const r of n.data.list)await this.writeDataToDoc(r.createdAt,r.content),i.push(r.id);const a=await fetch("https://sd.cloud.ifbemore.com/api/v1/note/records",{method:"POST",headers:{Authorization:`Bearer ${this.config.token}`,"Content-Type":"application/json"},body:JSON.stringify({ids:i})});if(!a.ok)throw new Error(`确认请求失败: ${a.status}`)}t&&p.showMessage("同步成功")}catch(s){t&&p.showMessage(`同步失败: ${s.message}`)}}async writeDataToDoc(t,s){const n=new Date(t),i=n.getTime();console.log(`开始写入文档 [${this.config.selectedDocName}]，时间为 [${i}]`),console.log(`写入数据为 [${s}]`);const a=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),h=String(n.getDate()).padStart(2,"0"),d=String(n.getHours()).padStart(2,"0"),o=String(n.getMinutes()).padStart(2,"0"),c=`${a}-${r}-${h} ${d}:${o}`;console.log(`日期字符串为 [${c}]`);try{return new Promise(g=>{const l=i-this.lastSyncTime;console.log(` 时间差： ${l}`),this.lastSyncTime==0||i-this.lastSyncTime>300*1e3?(this.lastSyncTime=i,this.saveData("syncTiem.json",this.lastSyncTime).then(()=>{console.log(`开始写入文档 [${this.config.selectedDocName}]，最后时间为+++ [${this.lastSyncTime}]`),p.fetchPost("/api/block/appendBlock",{dataType:"markdown",data:`## ${c}`,parentID:this.config.selectedDocId},()=>{p.fetchPost("/api/block/appendBlock",{dataType:"markdown",data:typeof s=="string"?s:JSON.stringify(s,null,2),parentID:this.config.selectedDocId},()=>{g()})})})):(console.log(`开始写入文档 [${this.config.selectedDocName}]，最后时间为=== [${this.lastSyncTime}]`),p.fetchPost("/api/block/appendBlock",{dataType:"markdown",data:typeof s=="string"?s:JSON.stringify(s,null,2),parentID:this.config.selectedDocId},()=>{g()}))})}catch(g){throw console.error("写入文档失败:",g),g}}onunload(){console.log("插件卸载，清理定时器"),this.syncTimer&&clearInterval(this.syncTimer)}}module.exports=O;
